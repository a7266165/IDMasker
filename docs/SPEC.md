# IDMasker - 資料夾去識別化工具 需求規格書

## 1. 概述

將含有可識別編號的資料夾名稱，透過 FPE 加密轉換為去識別化名稱。
資料夾內容完全不做改動，僅重新命名資料夾。
使用者可透過密碼進行還原（解密）。

## 2. 資料夾名稱結構

### 2.1 原始格式
```
XXXXXXXXYYYYMMDDHHMI
```
- `XXXXXXXX`: 前 8 碼純數字編號（**需加密的目標**）
- `YYYYMMDDHHMI`: 後 12 碼日期時間（年月日時分，**保留不動**）
- 共 20 碼純數字，無分隔符

### 2.2 去識別化後格式
```
YYYYMMDDHHMI<4英文><6數字>
```
- 日期時間移至前方
- 加密後字串（4英文大小寫混合 + 6數字）直接接續，**無分隔符**

### 2.3 範例
```
加密前: 12345678202602060821
加密後: 202602060821AbCd123456

還原:   202602060821AbCd123456
還原後: 12345678202602060821
```

## 3. 操作流程

### 3.1 加密（去識別化）
```
1. 使用者透過 GUI 選擇父資料夾
2. 軟體自動掃描所有符合 20碼純數字 格式的子資料夾
3. 使用者輸入密碼（需輸入兩次確認）
4. 軟體對每個資料夾的 8 碼編號進行 FPE 加密
5. 資料夾重新命名為: YYYYMMDDHHMI<4英文><6數字>（無分隔符）
6. 資料夾內容不做任何改動
```

### 3.2 解密（還原）
```
1. 使用者透過 GUI 選擇父資料夾
2. 軟體自動掃描所有符合 12碼+4英文+6數字（共22碼）格式的子資料夾
3. 使用者輸入密碼（需輸入兩次確認）
4. 軟體對加密字串進行解密，還原出原始 8 碼編號
5. 資料夾重新命名為: XXXXXXXXYYYYMMDDHHMI
```

## 4. 加密方案

### 4.1 演算法
- **Format-Preserving Encryption (FPE)** 概念
- 使用 Feistel 網絡實現有限域上的加密
- 輸出格式：4 英文字母（大小寫混合）+ 6 數字

### 4.2 Key 衍生
- 使用 PBKDF2-HMAC-SHA256 從使用者密碼衍生 256-bit key
- Salt: 固定值（確保同密碼 + 同輸入 = 同輸出）

### 4.3 加密流程
1. 輸入 8 碼數字視為整數 N（0 ~ 99,999,999）
2. 使用 Feistel 網絡（8 輪）加密得到整數 M（0 ~ 99,999,999）
3. 將 M 轉換為輸出格式：
   - 字母部分 = M // 1,000,000（0 ~ 99）→ 轉為 4 個英文字母
   - 數字部分 = M % 1,000,000（0 ~ 999,999）→ 轉為 6 位數字

### 4.4 輸出格式說明
- 4 英文字母：使用 52 進位編碼（A-Z, a-z）
- 由於輸入空間為 10^8，字母組合約有 100 種變化
- 6 數字：直接使用，補零至 6 位

### 4.5 安全特性
- 無密碼無法逆推原始編號
- 同一密碼 + 同一編號 → 永遠產生相同加密結果（確定性）
- 碰撞機率: 零（Feistel 網絡為一對一映射）
- 可完全逆向解密

## 5. GUI 介面設計

### 5.1 技術
- Python tkinter（內建，無需額外安裝）

### 5.2 介面元素（5 個輸入欄位）
```
┌──────────────────────────────────────────┐
│            IDMasker 去識別化工具            │
├──────────────────────────────────────────┤
│                                          │
│  來源資料夾: [____________________] [瀏覽] │
│  輸出資料夾: [____________________] [瀏覽] │
│  CSV 路徑:  [____________________] [瀏覽] │
│                                          │
│  密碼:       [____________________]       │
│  確認密碼:   [____________________]       │
│                                          │
│  [掃描資料夾]                              │
│                                          │
│  ┌─ 掃描結果 ────────────────────────┐   │
│  │ ☑ 12345678202602060821           │   │
│  │ ☑ 87654321202601150930           │   │
│  └──────────────────────────────────┘   │
│                                          │
│  [執行加密]                               │
│                                          │
│  狀態: 就緒                               │
└──────────────────────────────────────────┘
```

### 5.3 欄位說明
1. **來源資料夾**: 存放未加密子資料夾的母資料夾路徑
2. **輸出資料夾**: 加密後子資料夾的輸出母資料夾路徑
3. **CSV 路徑**: 加密報告 CSV 檔的輸出路徑
4. **密碼**: 用於加密的密碼
5. **確認密碼**: 密碼複檢（兩次不一致時提示錯誤）

### 5.4 操作行為
- 加密為**複製**操作：原始資料夾保留不動，加密後副本放到輸出目錄
- 掃描來源資料夾，列出符合 20 碼純數字格式的子資料夾
- 勾選要處理的資料夾
- 執行加密後自動產生 CSV 報告
- 顯示處理進度與結果

## 6. CSV 報告

### 6.1 summary.csv（加密總報告）
- 輸出路徑：使用者透過 GUI 指定
- 預設檔名：`summary.csv`

| 欄位 | 說明 |
|------|------|
| 原始病例編號 | 前 8 碼數字 ID |
| 資料夾日期 | 後 12 碼日期時間（YYYYMMDDHHMI） |
| 加密後檔名 | 加密後的 22 碼資料夾名稱 |
| 使用密碼 | 此次加密使用的密碼 |
| JPG 數量 | 資料夾內 .jpg 檔案的數量 |
| 有 JSON | 資料夾內是否有 .json 檔案（是/否） |
| 有 EDF | 資料夾內是否有 .edf 檔案（是/否） |
| 加密時間 | 執行加密的時間戳記 |

### 6.2 processed.csv（處理紀錄）
- 輸出路徑：自動輸出到**來源資料夾**

| 欄位 | 說明 |
|------|------|
| 病例號碼 | 前 8 碼數字 ID |
| 日期 | YYYYMMDD |
| 時間 | HHMI |
| 資料夾名稱 | 原始 20 碼資料夾名稱 |
| 轉檔時間 | 執行加密的時間戳記 |

### 6.3 備份
- 備份路徑：`C:\Users\Administrator\Documents\IDMasker\Backups`
- 備份內容：summary.csv 及 processed.csv
- 備份檔名：加上時間戳記（如 `summary_20260206_143000.csv`）
- 加密完成後自動備份

## 7. 技術規格

### 7.1 開發語言
- Python 3.10+

### 7.2 核心依賴
- `pycryptodome`: PBKDF2 金鑰衍生 + HMAC（用於 Feistel 輪函數）
- `tkinter`: GUI（Python 內建）
- `PyInstaller`: 打包為 exe

### 7.3 交付形式
- 單一 exe 執行檔，Windows 環境直接執行

### 7.4 專案結構
```
IDMasker/
├── docs/
│   ├── SPEC.md              # 本文件 - 需求規格書
│   └── OPEN_QUESTIONS.md    # 待確認事項
├── src/
│   ├── __init__.py
│   ├── main.py              # 程式進入點
│   ├── crypto.py            # 加密/解密核心邏輯
│   ├── folder_scanner.py    # 資料夾掃描、複製與重新命名
│   ├── csv_reporter.py      # CSV 報告產生
│   └── gui.py               # tkinter GUI
├── tests/
│   ├── test_crypto.py       # 加密解密測試
│   └── test_scanner.py      # 掃描邏輯測試
├── pyproject.toml
└── requirements.txt
```
